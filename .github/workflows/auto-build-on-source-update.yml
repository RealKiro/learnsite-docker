name: Auto-build LearnSite on Source Update

on:
  schedule:
    # 每月5日凌晨2:30 UTC 执行一次（北京时间10:30）
    - cron: '30 2 5 * *'
  workflow_dispatch:
    inputs:
      build_source:
        description: 'Build source (gitee or local)'
        required: true
        default: 'gitee'
        type: choice
        options:
          - gitee
          - local

jobs:
  check-and-build:
    runs-on: ubuntu-latest
    outputs:
      should_build: ${{ steps.check_commit.outputs.new_commit }}
      commit_time: ${{ steps.get_commit_time.outputs.commit_time }}
      commit_sha: ${{ steps.get_commit_sha.outputs.commit_sha }}

    steps:
      # 1. 检出当前仓库（包含自定义配置和记录文件）
      - name: Checkout own repo
        uses: actions/checkout@v4
        with:
          path: my-repo

      # 2. 确定构建来源（定时任务默认为 gitee，手动触发按选择）
      - name: Determine build source
        id: source
        run: |
          if [[ "${{ github.event_name }}" == "schedule" ]]; then
            echo "source=gitee" >> $GITHUB_OUTPUT
          else
            echo "source=${{ github.event.inputs.build_source }}" >> $GITHUB_OUTPUT
          fi

      # 3. 如果来源是 gitee，检查 Gitee 仓库是否有新提交
      - name: Fetch Gitee source and check for updates
        id: check_commit
        if: steps.source.outputs.source == 'gitee'
        run: |
          mkdir temp-source
          cd temp-source
          # 初始化 git 仓库并拉取最新提交元数据
          git init -b main
          git remote add origin https://gitee.com/jnschool/learnsite-wz.git
          git fetch --depth 1 origin master 2>&1 || git fetch --depth 1 origin main 2>&1
          LATEST_SHA=$(git rev-parse FETCH_HEAD)
          LATEST_COMMIT_TIME=$(git show -s --format=%ct FETCH_HEAD)
          echo "Latest commit SHA: $LATEST_SHA"
          echo "commit_sha=$LATEST_SHA" >> $GITHUB_OUTPUT
          echo "commit_time=$LATEST_COMMIT_TIME" >> $GITHUB_OUTPUT

          # 读取上次构建的commit记录
          LAST_BUILD_SHA=""
          if [ -f ../my-repo/last_build_commit.txt ]; then
            LAST_BUILD_SHA=$(cat ../my-repo/last_build_commit.txt)
          fi

          if [ "$LATEST_SHA" != "$LAST_BUILD_SHA" ]; then
            echo "new_commit=true" >> $GITHUB_OUTPUT
            echo "New commit detected. Proceeding with build."
          else
            echo "new_commit=false" >> $GITHUB_OUTPUT
            echo "No new commit. Skipping build."
          fi
          cd ..

      # 4. 如果是手动触发且来源为 local，直接使用本地文件构建
      - name: Prepare build context from local
        if: steps.source.outputs.source == 'local'
        run: |
          mkdir -p app-source
          # 复制当前仓库的所有文件到构建目录（排除 .git 和 my-repo）
          rsync -av --exclude='.git' --exclude='my-repo' ./ app-source/
          echo "Using local files for build."

      # 5. 如果来源是 gitee 且有新提交，克隆完整源码并准备构建目录
      - name: Clone Gitee source and prepare build context
        if: steps.source.outputs.source == 'gitee' && steps.check_commit.outputs.new_commit == 'true'
        run: |
          mkdir -p app-source
          git clone --depth 1 https://gitee.com/jnschool/learnsite-wz.git learnsite-source
          cd learnsite-source
          # 定位实际源码目录（根据仓库结构）
          if [ -d "LearnSiteDev" ]; then
            mv LearnSiteDev/* ../app-source/
            mv LearnSiteDev/.[!.]* ../app-source/ 2>/dev/null || true
          elif [ -d "LearnSite_ChengDu" ]; then
            mv LearnSite_ChengDu/* ../app-source/
            mv LearnSite_ChengDu/.[!.]* ../app-source/ 2>/dev/null || true
          else
            rsync -av --exclude='.git' ./ ../app-source/
          fi
          cd ..
          rm -rf learnsite-source

      # 6. 替换为自定义配置（从 my-repo 复制 web.config 和 Dockerfile 等）
      - name: Replace with custom configs
        if: (steps.source.outputs.source == 'gitee' && steps.check_commit.outputs.new_commit == 'true') || steps.source.outputs.source == 'local'
        run: |
          cp my-repo/web.config app-source/ 2>/dev/null || echo "Warning: web.config not found in my-repo"
          cp my-repo/Dockerfile app-source/ 2>/dev/null || echo "Warning: Dockerfile not found in my-repo, using default if exists"
          cp my-repo/entrypoint.sh app-source/ 2>/dev/null || echo "Warning: entrypoint.sh not found in my-repo"

      # 7. 格式化提交时间为 Docker 标签（仅对 gitee 来源有效）
      - name: Format commit time for Docker tag
        id: format_time
        if: steps.source.outputs.source == 'gitee' && steps.check_commit.outputs.new_commit == 'true'
        run: |
          FORMATTED_TIME=$(date -u -d @${{ steps.check_commit.outputs.commit_time }} +'%Y%m%d-%H%M%S')
          echo "formatted_time=$FORMATTED_TIME" >> $GITHUB_OUTPUT

      # 8. 登录 Docker Hub
      - name: Login to Docker Hub
        if: (steps.source.outputs.source == 'gitee' && steps.check_commit.outputs.new_commit == 'true') || steps.source.outputs.source == 'local'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # 9. 构建并推送镜像
      - name: Build and push
        if: (steps.source.outputs.source == 'gitee' && steps.check_commit.outputs.new_commit == 'true') || steps.source.outputs.source == 'local'
        uses: docker/build-push-action@v5
        with:
          context: ./app-source
          file: ./app-source/Dockerfile
          push: true
          tags: |
            ${{ secrets.DOCKER_USERNAME }}/learnsite-web:${{ steps.source.outputs.source == 'gitee' && steps.format_time.outputs.formatted_time || 'manual' }}
            ${{ secrets.DOCKER_USERNAME }}/learnsite-web:latest
          labels: |
            org.opencontainers.image.source=${{ github.server_url }}/${{ github.repository }}
            org.opencontainers.image.revision=${{ steps.source.outputs.source == 'gitee' && steps.check_commit.outputs.commit_sha || github.sha }}

      # 10. 如果是 gitee 构建且成功，记录本次构建的 commit SHA（用于下次比较）
      - name: Record last build commit (gitee only)
        if: steps.source.outputs.source == 'gitee' && steps.check_commit.outputs.new_commit == 'true'
        run: |
          echo ${{ steps.check_commit.outputs.commit_sha }} > my-repo/last_build_commit.txt
          # 可选：将记录文件推回仓库（需配置 git 权限）
          # cd my-repo
          # git config user.name "github-actions[bot]"
          # git config user.email "github-actions[bot]@users.noreply.github.com"
          # git add last_build_commit.txt
          # git commit -m "Update last build commit to ${{ steps.check_commit.outputs.commit_sha }}"
          # git push
