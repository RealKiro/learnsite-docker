name: Docker Compose CI

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master ]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆåå°ï¼‰
      - name: Build and start services
        run: docker compose up -d --build
        env:
          MSSQL_SA_PASSWORD: LearnSite!2025StrongPwd

      # æ˜¾ç¤ºå®¹å™¨çŠ¶æ€ï¼ˆå¿«é€Ÿè¯Šæ–­ï¼‰
      - name: Show container status
        run: |
          docker compose ps
          docker compose logs --tail=20 web

      # è·å– Web å®¹å™¨çš„ IP åœ°å€ï¼ˆå…³é”®æ­¥éª¤ï¼‰
      - name: Get web container IP
        id: web_ip
        run: |
          WEB_CONTAINER=$(docker compose ps -q web)
          WEB_IP=$(docker inspect -f '{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}' $WEB_CONTAINER)
          echo "WEB_IP=$WEB_IP" >> $GITHUB_OUTPUT
          echo "Web container IP: $WEB_IP"

      # ç­‰å¾… Web æœåŠ¡å°±ç»ªï¼ˆç›´æ¥è®¿é—®å®¹å™¨ IP:9000ï¼‰
      - name: Wait for web service to be ready
        run: |
          WEB_IP="${{ steps.web_ip.outputs.WEB_IP }}"
          echo "â³ Waiting for web service at http://${WEB_IP}:9000 ..."
          timeout 120s sh -c '
            until curl -s --fail "http://${WEB_IP}:9000"; do
              echo "   Still waiting... (container status below)"
              docker compose ps web
              echo "   Last 5 lines of web logs:"
              docker compose logs --tail=5 web
              echo ""
              sleep 5
            done
          '
          echo "âœ… Web service is ready!"

      # æ ¸å¿ƒæµ‹è¯•ï¼šè®¿é—® Web æœåŠ¡
      - name: Test web service
        run: |
          WEB_IP="${{ steps.web_ip.outputs.WEB_IP }}"
          curl -v --fail "http://${WEB_IP}:9000" || (echo "âŒ Web test failed" && exit 1)

      # ï¼ˆå¯é€‰ï¼‰æµ‹è¯•æ•°æ®åº“è¿æ¥
      - name: Test database connectivity
        run: |
          echo "ğŸ” Checking SQL Server connection..."
          sleep 20
          docker compose exec -T db /opt/mssql-tools18/bin/sqlcmd \
            -S localhost -U sa -P "LearnSite!2025StrongPwd" \
            -C -Q "SELECT @@VERSION" \
            && echo "âœ… Database connection successful" \
            || echo "âš ï¸ Warning: Database not ready, continuing"
        continue-on-error: true

      # æ¸…ç†èµ„æº
      - name: Stop and clean up
        if: always()
        run: docker compose down -v
