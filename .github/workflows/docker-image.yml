name: CI - Automated Testing

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    # 支持中文 locale
    env:
      LANG: zh_CN.UTF-8
      LANGUAGE: zh_CN:zh
      LC_ALL: zh_CN.UTF-8

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # 1. 安装中文 locale
      - name: Setup locale (zh_CN.UTF-8)
        run: |
          sudo apt-get update
          sudo apt-get install -y locales
          sudo sed -i 's/^# *\(zh_CN.UTF-8\)/\1/' /etc/locale.gen
          sudo locale-gen zh_CN.UTF-8

      # 2. 安装 Mono + NuGet 命令行工具（nuget 包已包含）
      - name: Install Mono and NuGet
        run: |
          sudo apt-get update
          sudo apt-get install -y mono-complete mono-xsp4 ca-certificates-mono nuget
          mono --version
          nuget help  # 验证安装

      # 3. 自动查找解决方案文件并恢复 NuGet 包
      - name: Restore NuGet packages
        run: |
          SLN_FILE=$(find . -name "*.sln" | head -n 1)
          if [ -n "$SLN_FILE" ]; then
            echo "Found solution: $SLN_FILE"
            nuget restore "$SLN_FILE"
          else
            echo "No .sln file found, skipping restore."
          fi

      # 4. 构建项目（使用 msbuild，Mono 已自带）
      - name: Build
        run: |
          SLN_FILE=$(find . -name "*.sln" | head -n 1)
          if [ -n "$SLN_FILE" ]; then
            msbuild /p:Configuration=Release "$SLN_FILE"
          else
            echo "No .sln file found, skipping build."
          fi

      # 5. 运行测试（请根据实际测试框架调整）
      - name: Run tests
        run: |
          # 示例：使用 nunit-console（需要安装 nunit-console 包）
          # sudo apt-get install -y nunit-console
          # nunit-console ./tests/bin/Release/YourTestProject.dll
          echo "Add your test command here"
        continue-on-error: false

      # 6. （可选）构建 Docker 镜像并验证
      - name: Build Docker image (optional)
        run: |
          docker build -t your-app:test .
          docker run --rm your-app:test xsp4 --version
