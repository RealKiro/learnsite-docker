name: Docker Compose CI

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master ]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      # 1. 检出代码
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. 设置 Docker Buildx（可选，用于高级构建功能）
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # 3. 使用 Docker Compose V2（无需额外安装，runner 已内置）
      - name: Build and start services with Docker Compose
        run: |
          docker compose up -d --build
        env:
          # 可在此覆盖 docker-compose.yaml 中的环境变量
          MSSQL_SA_PASSWORD: LearnSite!2025StrongPwd

      # 4. 等待 Web 服务完全启动（最长等待 60 秒）
      - name: Wait for web service to be ready
        run: |
          echo "Waiting for web service on http://localhost:8888 ..."
          timeout 60s sh -c 'until curl -s --fail http://localhost:8888; do \
            echo "Still waiting..."; sleep 3; \
          done'
          echo "Web service is ready!"

      # 5. 测试 Web 服务是否正常响应（HTTP 200）
      - name: Test web service
        run: |
          curl -f http://localhost:8888 || (echo "Web test failed" && exit 1)

      # 6. （可选）测试数据库连接
      - name: Test database connectivity
        run: |
          echo "Checking SQL Server connection..."
          # 等待数据库初始化（约 20 秒）
          sleep 20
          docker compose exec -T db /opt/mssql-tools18/bin/sqlcmd \
            -S localhost -U sa -P "LearnSite!2025StrongPwd" \
            -C -Q "SELECT @@VERSION" \
            && echo "Database connection successful" \
            || echo "Warning: Database not ready, but continuing"
        continue-on-error: true   # 数据库非必需，不影响整体结果

      # 7. 始终停止并移除容器（保证环境清洁）
      - name: Stop and clean up
        if: always()
        run: docker compose down -v
