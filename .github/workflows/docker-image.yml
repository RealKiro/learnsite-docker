name: Docker Compose CI

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master ]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # ---------- å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆåå°ï¼‰----------
      - name: Build and start services
        run: docker compose up -d --build
        env:
          MSSQL_SA_PASSWORD: LearnSite!2025StrongPwd

      # ---------- ç«‹å³æ‰“å°å®¹å™¨çŠ¶æ€ï¼Œç”¨äºè¯Šæ–­ ----------
      - name: Show container status
        run: docker compose ps

      - name: Show web service logs (first 50 lines)
        run: docker compose logs --tail=50 web

      # ---------- ç­‰å¾… Web æœåŠ¡å°±ç»ªï¼ˆæœ€é•¿ 180 ç§’ï¼‰----------
      - name: Wait for web service to be ready
        run: |
          echo "â³ Waiting for web service on http://localhost:8888 ..."
          timeout 180s sh -c '
            until curl -s --fail http://localhost:8888; do
              echo "   Still waiting... (container status below)"
              docker compose ps web
              echo "   Last 5 lines of web logs:"
              docker compose logs --tail=5 web
              echo ""
              sleep 5
            done
          '
          echo "âœ… Web service is ready!"

      # ---------- æ ¸å¿ƒæµ‹è¯•ï¼šWeb å“åº” ----------
      - name: Test web service (HTTP 200)
        run: |
          curl -v --fail http://localhost:8888 || (echo "âŒ Web test failed" && exit 1)

      # ---------- å¯é€‰ï¼šæ•°æ®åº“è¿æ¥æµ‹è¯• ----------
      - name: Test database connectivity
        run: |
          echo "ğŸ” Checking SQL Server connection..."
          # ç­‰å¾…æ•°æ®åº“å®Œå…¨å¯åŠ¨
          sleep 20
          docker compose exec -T db /opt/mssql-tools18/bin/sqlcmd \
            -S localhost -U sa -P "LearnSite!2025StrongPwd" \
            -C -Q "SELECT @@VERSION" \
            && echo "âœ… Database connection successful" \
            || echo "âš ï¸ Warning: Database not ready, continuing"
        continue-on-error: true

      # ---------- æ— è®ºæˆåŠŸä¸å¦ï¼Œæ¸…ç†èµ„æº ----------
      - name: Stop and clean up
        if: always()
        run: docker compose down -v
