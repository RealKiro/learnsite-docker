name: CI - Automated Testing

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    # 支持中文 locale（解决中文乱码问题）
    env:
      LANG: zh_CN.UTF-8
      LANGUAGE: zh_CN:zh
      LC_ALL: zh_CN.UTF-8

    steps:
      # 1. 检出代码
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. 设置并生成中文 locale
      - name: Setup locale (zh_CN.UTF-8)
        run: |
          sudo apt-get update
          sudo apt-get install -y locales
          sudo sed -i 's/^# *\(zh_CN.UTF-8\)/\1/' /etc/locale.gen
          sudo locale-gen zh_CN.UTF-8

      # 3. 安装 Mono（如果项目需要特定版本，可指定）
      - name: Install Mono
        run: |
          sudo apt-get update
          sudo apt-get install -y mono-complete mono-xsp4 ca-certificates-mono
          mono --version

      # 4. 恢复 NuGet 包（如果有 .sln 或 .csproj）
      - name: Restore NuGet packages
        run: |
          nuget restore YourSolution.sln   # 替换为实际的解决方案文件
        continue-on-error: true            # 如果没有 NuGet 项目则跳过

      # 5. 构建项目（使用 msbuild 或 xbuild）
      - name: Build
        run: |
          msbuild /p:Configuration=Release YourSolution.sln   # 或使用 xbuild

      # 6. 运行单元测试（例如使用 NUnit, xUnit, MSTest）
      - name: Run tests
        run: |
          # 假设测试项目输出到 ./tests/bin/Release，使用 nunit-console
          nunit-console ./tests/bin/Release/YourTestProject.dll
        continue-on-error: false

      # 可选：如果使用 Docker 构建并测试，可以在此步进行
      - name: Build Docker image (optional)
        run: |
          docker build -t your-app:test .
          docker run --rm your-app:test xsp4 --version   # 简单验证

      # 可选：上传测试结果
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: TestResult.xml   # 根据测试框架实际输出路径调整
