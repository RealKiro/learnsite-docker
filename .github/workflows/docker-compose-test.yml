name: Docker Compose Integration Test (CI)

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # èµ‹äºˆå…¥å£è„šæœ¬æ‰§è¡Œæƒé™
      - name: Set execute permission on entrypoint script
        run: chmod +x entrypoint.ci.sh

      # å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼Œé€šè¿‡ç¯å¢ƒå˜é‡ä¼ é€’å¯†ç 
      - name: Start services
        run: |
          MSSQL_SA_PASSWORD="${{ secrets.DB_PASSWORD }}" \
          DB_PASSWORD="${{ secrets.DB_PASSWORD }}" \
          docker compose -f docker-compose.ci.yml up -d

      - name: List containers
        run: docker ps -a

      # æ£€æŸ¥ MSSQL å®¹å™¨æ˜¯å¦æ­£åœ¨è¿è¡Œ
      - name: Check MSSQL container status
        run: |
          if ! docker ps --filter "name=mssql-ci" --format '{{.Names}}' | grep -q mssql-ci; then
            echo "âŒ MSSQL container is not running. Logs:"
            docker logs mssql-ci || echo "No logs available."
            exit 1
          fi
          echo "âœ… MSSQL container is running."

      # ç­‰å¾… MSSQL å®¹å™¨å®Œæˆæ•°æ®åº“åˆå§‹åŒ–ï¼ˆæ£€æµ‹æ ‡è®°æ–‡ä»¶ï¼‰
      - name: Wait for MSSQL to initialize
        run: |
          echo "â³ Waiting for MSSQL to initialize database..."
          timeout 180s bash -c "until docker exec mssql-ci test -f /var/opt/mssql/db_initialized; do sleep 5; done"
          echo "âœ… MSSQL initialized."

      # ========== æ–°å¢ï¼šéªŒè¯æ•°æ®åº“æ˜¯å¦æˆåŠŸåˆ›å»º ==========
      - name: Verify database 'learnsite' exists
        run: |
          echo "ğŸ” Checking if database 'learnsite' exists..."
          DB_EXISTS=$(docker run --rm --network learnsite-net mcr.microsoft.com/mssql-tools \
            /opt/mssql-tools18/bin/sqlcmd -S mssql -U sa -P "${{ secrets.DB_PASSWORD }}" \
            -Q "SET NOCOUNT ON; SELECT name FROM sys.databases WHERE name = 'learnsite'" -h -1)
          if [ -n "$DB_EXISTS" ]; then
            echo "âœ… Database 'learnsite' exists."
          else
            echo "âŒ Database 'learnsite' does not exist. Initialization may have failed."
            exit 1
          fi

      # éªŒè¯å…³é”®è¡¨æ˜¯å¦å­˜åœ¨ï¼ˆä¾‹å¦‚ Student è¡¨ï¼‰
      - name: Verify table 'Student' exists
        run: |
          echo "ğŸ” Checking if table 'Student' exists in learnsite database..."
          TABLE_COUNT=$(docker run --rm --network learnsite-net mcr.microsoft.com/mssql-tools \
            /opt/mssql-tools18/bin/sqlcmd -S mssql -U sa -P "${{ secrets.DB_PASSWORD }}" -d learnsite \
            -Q "SET NOCOUNT ON; SELECT COUNT(*) FROM information_schema.tables WHERE table_name = 'Student'" -h -1)
          if [ "$TABLE_COUNT" -gt 0 ]; then
            echo "âœ… Table 'Student' exists."
          else
            echo "âš ï¸ Table 'Student' not found. This might be normal if the app creates tables via upgrade page."
          fi

      # ç­‰å¾… LearnSite å®¹å™¨åˆå§‹åŒ–å®Œæˆï¼ˆæ£€æµ‹æ ‡è®°æ–‡ä»¶ï¼‰
      - name: Wait for LearnSite to initialize
        run: |
          echo "â³ Waiting for LearnSite to finish initialization..."
          timeout 120s bash -c "until docker exec learnsite-ci test -f /app/.initialized; do sleep 5; done"
          echo "âœ… LearnSite initialized."

      # ========== è§¦å‘å‡çº§é¡µé¢ï¼Œç¡®ä¿æ‰€æœ‰è¡¨åˆ›å»º ==========
      - name: Trigger upgrade page
        run: |
          echo "ğŸ” Accessing /upgrade.aspx to ensure tables are created..."
          curl -s -X POST -d "Btnupgrade=æ‰§è¡Œæ›´æ–°" http://localhost:8080/upgrade.aspx || true
          sleep 5

      # æµ‹è¯•ç½‘ç«™é¦–é¡µ
      - name: Test web service
        run: |
          curl -f --retry 5 --retry-delay 5 http://localhost:8080 || (echo "âŒ Web test failed" && exit 1)
          echo "âœ… Web service responded successfully."

      # å¤±è´¥æ—¶è¾“å‡ºæ—¥å¿—
      - name: Display logs on failure
        if: failure()
        run: |
          echo "===== learnsite logs ====="
          docker logs learnsite-ci --tail 50
          echo "===== mssql logs ====="
          docker logs mssql-ci --tail 50

      # æ¸…ç†èµ„æº
      - name: Clean up
        if: always()
        run: docker compose -f docker-compose.ci.yml down -v