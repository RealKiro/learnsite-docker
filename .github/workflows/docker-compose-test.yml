name: Docker Compose Integration Test (CI)

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼Œé€šè¿‡ç¯å¢ƒå˜é‡ä¼ é€’å¯†ç 
      - name: Start services
        run: |
          MSSQL_SA_PASSWORD="${{ secrets.DB_PASSWORD }}" \
          DB_PASSWORD="${{ secrets.DB_PASSWORD }}" \
          docker compose -f docker-compose.ci.yml up -d

      - name: List containers
        run: docker ps -a

      # ========== ç¬¬ä¸€æ­¥ï¼šæµ‹è¯• learnsite å’Œ mssql è¿æ¥ ==========
      - name: Check 1 - Test database connection
        run: |
          echo "ğŸ” æ£€æŸ¥æ­¥éª¤1ï¼šæµ‹è¯• learnsite å®¹å™¨èƒ½å¦è¿æ¥åˆ° mssql å®¹å™¨..."
          # ä½¿ç”¨ learnsite å®¹å™¨å°è¯•è¿æ¥æ•°æ®åº“ï¼ˆéœ€å®¹å™¨å†…æœ‰ sqlcmd æˆ– mysql å®¢æˆ·ç«¯ï¼‰
          # ç”±äº learnsite å®¹å™¨åŸºäº Monoï¼Œå¯èƒ½æ²¡æœ‰ sqlcmdï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸´æ—¶å®¹å™¨æµ‹è¯•
          if docker run --rm --network learnsite-net mcr.microsoft.com/mssql-tools \
            /opt/mssql-tools/bin/sqlcmd -S mssql -U sa -P "${{ secrets.DB_PASSWORD }}" -Q "SELECT 1" > /dev/null 2>&1; then
            echo "âœ… è¿æ¥æˆåŠŸï¼šlearnsite å¯ä»¥æ­£å¸¸è¿æ¥åˆ° mssqlï¼Œå¯†ç æ­£ç¡®ã€‚"
          else
            echo "âŒ è¿æ¥å¤±è´¥ï¼šæ— æ³•è¿æ¥åˆ° mssqlï¼Œè¯·æ£€æŸ¥å¯†ç æ˜¯å¦æ­£ç¡®æˆ– mssql æ˜¯å¦å¥åº·ã€‚"
            docker logs mssql-ci --tail 20
            exit 1
          fi

      # ========== ç¬¬äºŒæ­¥ï¼šæ£€æŸ¥ learnsite æ•°æ®åº“æ˜¯å¦å­˜åœ¨ ==========
      - name: Check 2 - Verify database 'learnsite' exists
        run: |
          echo "ğŸ” æ£€æŸ¥æ­¥éª¤2ï¼šéªŒè¯æ•°æ®åº“ 'learnsite' æ˜¯å¦å·²åˆ›å»º..."
          # æŸ¥è¯¢ sys.databases çœ‹æ˜¯å¦å­˜åœ¨ learnsite æ•°æ®åº“
          DB_EXISTS=$(docker run --rm --network learnsite-net mcr.microsoft.com/mssql-tools \
            /opt/mssql-tools/bin/sqlcmd -S mssql -U sa -P "${{ secrets.DB_PASSWORD }}" \
            -Q "SET NOCOUNT ON; SELECT name FROM sys.databases WHERE name = 'learnsite'" -h -1)
          if [ -n "$DB_EXISTS" ]; then
            echo "âœ… æ•°æ®åº“ 'learnsite' å·²å­˜åœ¨ã€‚"
          else
            echo "âš ï¸ æ•°æ®åº“ 'learnsite' å°šæœªåˆ›å»ºï¼Œå°†åœ¨å‡çº§é¡µé¢è§¦å‘åè‡ªåŠ¨åˆ›å»ºã€‚"
          fi

      # ========== ç¬¬ä¸‰æ­¥ï¼šè§¦å‘ upgrade.aspx å‡çº§å¹¶æ£€æŸ¥ç»“æœ ==========
      - name: Check 3 - Trigger database upgrade via upgrade.aspx
        run: |
          echo "ğŸ” æ£€æŸ¥æ­¥éª¤3ï¼šè®¿é—®å‡çº§é¡µé¢ /upgrade.aspx å¹¶æ¨¡æ‹Ÿç‚¹å‡»â€œæ‰§è¡Œæ›´æ–°â€æŒ‰é’®..."
          # ç­‰å¾… learnsite æœåŠ¡å¯åŠ¨
          timeout 60s bash -c "until curl -s http://localhost:8080 > /dev/null; do sleep 2; done"
          
          # æ¨¡æ‹Ÿç‚¹å‡»â€œæ‰§è¡Œæ›´æ–°â€æŒ‰é’®ï¼ˆPOST è¯·æ±‚ï¼Œæºå¸¦æŒ‰é’®åç§°ï¼‰
          RESPONSE=$(curl -s -X POST -d "Btnupgrade=æ‰§è¡Œæ›´æ–°" http://localhost:8080/upgrade.aspx)
          
          # æ£€æŸ¥å“åº”ä¸­æ˜¯å¦åŒ…å«æˆåŠŸæç¤ºï¼ˆæ ¹æ®å®é™…é¡µé¢è¾“å‡ºè°ƒæ•´å…³é”®å­—ï¼‰
          if echo "$RESPONSE" | grep -q "æ›´æ–°å®Œæˆ\|å‡çº§æˆåŠŸ\|Labelmsg"; then
            echo "âœ… å‡çº§é¡µé¢æ‰§è¡ŒæˆåŠŸï¼Œæ•°æ®åº“è¡¨å·²åˆ›å»ºã€‚"
          else
            echo "âš ï¸ å‡çº§é¡µé¢å¯èƒ½æœªæŒ‰é¢„æœŸæ‰§è¡Œï¼Œè¯·æ£€æŸ¥å“åº”å†…å®¹ï¼š"
            echo "$RESPONSE" | head -20
            # ä¸é€€å‡ºï¼Œç»§ç»­å°è¯•è®¿é—®é¦–é¡µ
          fi

          # å†æ¬¡éªŒè¯æ•°æ®åº“è¡¨æ˜¯å¦å­˜åœ¨ï¼ˆå¯é€‰ï¼Œä¾‹å¦‚æ£€æŸ¥æŸå¼ è¡¨ï¼‰
          TABLE_EXISTS=$(docker run --rm --network learnsite-net mcr.microsoft.com/mssql-tools \
            /opt/mssql-tools/bin/sqlcmd -S mssql -U sa -P "${{ secrets.DB_PASSWORD }}" -d learnsite \
            -Q "SET NOCOUNT ON; SELECT COUNT(*) FROM information_schema.tables WHERE table_name = 'YourTableName'" -h -1)
          # å¦‚æœæœ‰ç‰¹å®šçš„è¡¨åï¼Œå¯ä»¥æ›¿æ¢ YourTableName è¿›è¡Œæ£€æŸ¥ï¼Œè¿™é‡Œä»…ä½œç¤ºä¾‹
          echo "æ•°æ®åº“è¡¨æ£€æŸ¥æš‚æœªæ‰§è¡Œï¼ˆéœ€æŒ‡å®šå…·ä½“è¡¨åï¼‰"

      # æµ‹è¯•ç½‘ç«™é¦–é¡µ
      - name: Test web service
        run: |
          curl -f --retry 5 --retry-delay 5 http://localhost:8080 || (echo "âŒ Web test failed" && exit 1)
          echo "âœ… Web service responded successfully."

      - name: Display logs on failure
        if: failure()
        run: |
          echo "===== learnsite logs ====="
          docker logs learnsite-ci --tail 50
          echo "===== mssql logs ====="
          docker logs mssql-ci --tail 50

      - name: Clean up
        if: always()
        run: docker compose -f docker-compose.ci.yml down -v