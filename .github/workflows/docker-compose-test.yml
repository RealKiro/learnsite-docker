name: Docker Compose Integration Test (CI)

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼Œé€šè¿‡ç¯å¢ƒå˜é‡ä¼ é€’å¯†ç 
      - name: Start services
        run: |
          MSSQL_SA_PASSWORD="${{ secrets.DB_PASSWORD }}" \
          DB_PASSWORD="${{ secrets.DB_PASSWORD }}" \
          docker compose -f docker-compose.ci.yml up -d

      - name: List containers
        run: docker ps -a

      # ========== ç­‰å¾…æ•°æ®åº“çœŸæ­£å¯è¿æ¥ï¼ˆç›´æ¥åœ¨ mssql å®¹å™¨å†…æµ‹è¯•ï¼‰==========
      - name: Wait for database to be ready
        run: |
          echo "ğŸ” ç­‰å¾…æ•°æ®åº“å°±ç»ª..."
          for i in {1..30}; do
            # ç›´æ¥åœ¨ mssql å®¹å™¨å†…æ‰§è¡Œ sqlcmd è¿æ¥ localhost
            if docker exec mssql-ci /opt/mssql-tools/bin/sqlcmd -S localhost -U sa -P "${{ secrets.DB_PASSWORD }}" -Q "SELECT 1" > /dev/null 2>&1; then
              echo "âœ… æ•°æ®åº“å·²å°±ç»ªã€‚"
              break
            fi
            echo "Attempt $i: æ•°æ®åº“æœªå°±ç»ªï¼Œç­‰å¾…5ç§’..."
            sleep 5
            if [ $i -eq 30 ]; then
              echo "âŒ æ•°æ®åº“ç­‰å¾…è¶…æ—¶ï¼Œè¯·æ£€æŸ¥ mssql æ—¥å¿—ã€‚"
              docker logs mssql-ci --tail 50
              exit 1
            fi
          done

      # ========== ç­‰å¾… LearnSite åˆå§‹åŒ–å®Œæˆï¼ˆæ ‡è®°æ–‡ä»¶å‡ºç°ï¼‰==========
      - name: Wait for LearnSite to initialize
        run: |
          echo "ğŸ” ç­‰å¾… LearnSite å®Œæˆé¦–æ¬¡è¿è¡Œï¼ˆæ ‡è®°æ–‡ä»¶ .initializedï¼‰..."
          timeout 120s bash -c "until docker exec learnsite-ci test -f /app/.initialized; do sleep 5; done"
          echo "âœ… LearnSite åˆå§‹åŒ–å®Œæˆã€‚"

      # ========== æ£€æŸ¥ learnsite å’Œ mssql è¿æ¥ ==========
      - name: Check 1 - Test database connection from learnsite
        run: |
          echo "ğŸ” æ£€æŸ¥æ­¥éª¤1ï¼šæµ‹è¯• learnsite å®¹å™¨èƒ½å¦è¿æ¥åˆ° mssql å®¹å™¨..."
          # ä½¿ç”¨ä¸´æ—¶å®¹å™¨æµ‹è¯•ç½‘ç»œè¿æ¥
          if docker run --rm --network learnsite-net mcr.microsoft.com/mssql-tools \
            /opt/mssql-tools/bin/sqlcmd -S mssql -U sa -P "${{ secrets.DB_PASSWORD }}" -Q "SELECT 1" > /dev/null 2>&1; then
            echo "âœ… è¿æ¥æˆåŠŸï¼šlearnsite å¯ä»¥æ­£å¸¸è¿æ¥åˆ° mssqlï¼Œå¯†ç æ­£ç¡®ã€‚"
          else
            echo "âŒ è¿æ¥å¤±è´¥ï¼šæ— æ³•è¿æ¥åˆ° mssqlï¼Œè¯·æ£€æŸ¥å¯†ç æ˜¯å¦æ­£ç¡®ã€‚"
            docker logs mssql-ci --tail 20
            exit 1
          fi

      # ========== æ£€æŸ¥ learnsite æ•°æ®åº“æ˜¯å¦å­˜åœ¨ ==========
      - name: Check 2 - Verify database 'learnsite' exists
        run: |
          echo "ğŸ” æ£€æŸ¥æ­¥éª¤2ï¼šéªŒè¯æ•°æ®åº“ 'learnsite' æ˜¯å¦å·²åˆ›å»º..."
          DB_EXISTS=$(docker run --rm --network learnsite-net mcr.microsoft.com/mssql-tools \
            /opt/mssql-tools/bin/sqlcmd -S mssql -U sa -P "${{ secrets.DB_PASSWORD }}" \
            -Q "SET NOCOUNT ON; SELECT name FROM sys.databases WHERE name = 'learnsite'" -h -1)
          if [ -n "$DB_EXISTS" ]; then
            echo "âœ… æ•°æ®åº“ 'learnsite' å·²å­˜åœ¨ã€‚"
          else
            echo "âš ï¸ æ•°æ®åº“ 'learnsite' å°šæœªåˆ›å»ºï¼Œå°†åœ¨å‡çº§é¡µé¢è§¦å‘åè‡ªåŠ¨åˆ›å»ºã€‚"
          fi

      # ========== è§¦å‘ upgrade.aspx å‡çº§å¹¶æ£€æŸ¥ç»“æœ ==========
      - name: Check 3 - Trigger database upgrade via upgrade.aspx
        run: |
          echo "ğŸ” æ£€æŸ¥æ­¥éª¤3ï¼šè®¿é—®å‡çº§é¡µé¢ /upgrade.aspx å¹¶æ¨¡æ‹Ÿç‚¹å‡»â€œæ‰§è¡Œæ›´æ–°â€æŒ‰é’®..."
          # ç¡®ä¿ learnsite web æœåŠ¡å¯è®¿é—®
          timeout 30s bash -c "until curl -s http://localhost:8080 > /dev/null; do sleep 2; done"
          
          # æ¨¡æ‹Ÿç‚¹å‡»â€œæ‰§è¡Œæ›´æ–°â€æŒ‰é’®ï¼ˆPOST è¯·æ±‚ï¼Œæºå¸¦æŒ‰é’® nameï¼‰
          RESPONSE=$(curl -s -X POST -d "Btnupgrade=æ‰§è¡Œæ›´æ–°" http://localhost:8080/upgrade.aspx)
          
          # æ£€æŸ¥å“åº”ä¸­æ˜¯å¦åŒ…å«æˆåŠŸæç¤ºï¼ˆæ ¹æ® upgrade.aspx å®é™…è¾“å‡ºè°ƒæ•´ï¼‰
          if echo "$RESPONSE" | grep -q "æ›´æ–°å®Œæˆ\|å‡çº§æˆåŠŸ\|Labelmsg"; then
            echo "âœ… å‡çº§é¡µé¢æ‰§è¡ŒæˆåŠŸï¼Œæ•°æ®åº“è¡¨å·²åˆ›å»ºã€‚"
          else
            echo "âš ï¸ å‡çº§é¡µé¢å¯èƒ½æœªæŒ‰é¢„æœŸæ‰§è¡Œï¼Œè¯·æ£€æŸ¥å“åº”å†…å®¹ï¼š"
            echo "$RESPONSE" | head -20
          fi

          # éªŒè¯æŸå¼ å…³é”®è¡¨æ˜¯å¦å­˜åœ¨ï¼ˆä¾‹å¦‚ Student è¡¨ï¼‰
          TABLE_EXISTS=$(docker run --rm --network learnsite-net mcr.microsoft.com/mssql-tools \
            /opt/mssql-tools/bin/sqlcmd -S mssql -U sa -P "${{ secrets.DB_PASSWORD }}" -d learnsite \
            -Q "SET NOCOUNT ON; SELECT COUNT(*) FROM information_schema.tables WHERE table_name = 'Student'" -h -1)
          if [ "$TABLE_EXISTS" -gt 0 ]; then
            echo "âœ… å…³é”®è¡¨ 'Student' å·²å­˜åœ¨ï¼Œæ•°æ®åº“åˆå§‹åŒ–æˆåŠŸã€‚"
          else
            echo "âš ï¸ å…³é”®è¡¨ 'Student' ä¸å­˜åœ¨ï¼Œå¯èƒ½åˆå§‹åŒ–æœªå®Œæˆã€‚"
          fi

      # æµ‹è¯•ç½‘ç«™é¦–é¡µ
      - name: Test web service
        run: |
          curl -f --retry 5 --retry-delay 5 http://localhost:8080 || (echo "âŒ Web test failed" && exit 1)
          echo "âœ… Web service responded successfully."

      - name: Display logs on failure
        if: failure()
        run: |
          echo "===== learnsite logs ====="
          docker logs learnsite-ci --tail 50
          echo "===== mssql logs ====="
          docker logs mssql-ci --tail 50

      - name: Clean up
        if: always()
        run: docker compose -f docker-compose.ci.yml down -v