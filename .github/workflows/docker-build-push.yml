name: Build and Push Docker Image

on:
  push:
    branches: [ main ]          # 根据实际主分支名修改
    tags: [ 'v*' ]             # 可选：当推送 v1.0.0 这类标签时也触发

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Docker Login
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}      # 请替换为您设置的 secret 名称
          password: ${{ secrets.DOCKER_PASSWORD }}      # 请替换为您设置的 token secret 名称

      - name: Docker meta (动态生成标签)
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: orzg/learnsite-web   # ⚠️ 必须改为您的镜像名
          tags: |
            type=raw,value=latest,enable=${{ github.ref == 'refs/heads/main' }}
            type=sha,format=short
            type=semver,pattern={{version}}   # 当 push tag 时自动提取版本号

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
