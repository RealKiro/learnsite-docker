name: Build Dev Image (auto)

on:
  push:
    branches: [ main, master ]          # 每次推送到 main/master 时自动构建 dev
  workflow_dispatch:                     # 也支持手动触发

jobs:
  build-dev:
    runs-on: ubuntu-latest

    steps:
      # 1. 检出当前仓库（包含自定义配置：web.config、Dockerfile、entrypoint.sh 等）
      - name: Checkout config repo
        uses: actions/checkout@v4
        with:
          path: my-repo

      # 2. 从 GitHub 拉取 LearnSite 源码（固定 main 分支）
      - name: Clone source from GitHub
        run: |
          echo "Cloning from https://github.com/RealKiro/learnsite.git (main branch)..."
          git clone --depth 1 --branch main https://github.com/RealKiro/learnsite.git app-source

      # 3. 用仓库中的自定义配置覆盖源码中的对应文件
      - name: Replace with custom configs
        run: |
          cp my-repo/web.config app-source/ 2>/dev/null || echo "⚠️ Warning: web.config not found in my-repo, using default from source."
          cp my-repo/Dockerfile app-source/ || echo "⚠️ Warning: Dockerfile not found in my-repo, using default from source."
          cp my-repo/entrypoint.sh app-source/ || echo "⚠️ Warning: entrypoint.sh not found in my-repo, using default from source."

      # 4. 登录 Docker Hub
      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # 5. 构建并推送 dev 镜像（不进行任何瘦身，直接使用原始镜像）
      - name: Build and push dev image
        uses: docker/build-push-action@v5
        with:
          context: ./app-source
          file: ./app-source/Dockerfile
          push: true
          tags: ${{ secrets.DOCKER_USERNAME }}/learnsite-web:dev
          labels: |
            org.opencontainers.image.source=${{ github.server_url }}/${{ github.repository }}
            org.opencontainers.image.revision=${{ github.sha }}

      # 6. 将测试用的 Compose 文件复制到工作目录
      - name: Copy test compose file
        run: cp my-repo/docker-compose.ci.yml .

      # 7. 拉取 MSSQL 镜像（确保测试环境可用）
      - name: Pull MSSQL image
        run: docker pull ${{ secrets.DOCKER_USERNAME }}/mssql-learnsite:latest

      # 8. 运行集成测试（验证 dev 镜像是否正常工作）
      - name: Run integration tests
        env:
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
        run: |
          # 同时设置两个密码变量（值相同）
          MSSQL_SA_PASSWORD="$DB_PASSWORD" \
          DB_PASSWORD="$DB_PASSWORD" \
          docker compose -f docker-compose.ci.yml up -d
          echo "Waiting 30 seconds for services to start..."
          sleep 30
          # 测试首页，若失败则输出 learnsite 容器日志
          if ! curl -f --retry 5 --retry-delay 5 http://localhost:8080; then
            echo "❌ Web test failed. Dumping learnsite container logs:"
            docker logs learnsite-ci
            exit 1
          fi
          echo "✅ Web service responded successfully."
          # 清理测试环境
          docker compose -f docker-compose.ci.yml down

      # 9. 可选：清理中间镜像（但 dev 镜像已推送，无需清理本地）