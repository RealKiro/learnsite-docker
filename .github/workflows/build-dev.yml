name: Build Dev Image with SlimToolkit

on:
  push:
    branches: [ main, master ]          # 每次推送到 main/master 时自动构建 dev
  workflow_dispatch:                     # 也支持手动触发

jobs:
  build-dev:
    runs-on: ubuntu-latest

    steps:
      # 1. 检出当前仓库（包含自定义配置：web.config、Dockerfile、entrypoint.sh 等）
      - name: Checkout config repo
        uses: actions/checkout@v4
        with:
          path: my-repo

      # 2. 从 GitHub 拉取 LearnSite 源码（固定 main 分支）
      - name: Clone source from GitHub
        run: |
          echo "Cloning from https://github.com/RealKiro/learnsite.git (main branch)..."
          git clone --depth 1 --branch main https://github.com/RealKiro/learnsite.git app-source

      # 3. 用仓库中的自定义配置覆盖源码中的对应文件
      - name: Replace with custom configs
        run: |
          cp my-repo/web.config app-source/ 2>/dev/null || echo "⚠️ Warning: web.config not found in my-repo, using default from source."
          cp my-repo/Dockerfile app-source/ || echo "⚠️ Warning: Dockerfile not found in my-repo, using default from source."
          cp my-repo/entrypoint.sh app-source/ || echo "⚠️ Warning: entrypoint.sh not found in my-repo, using default from source."

      # 4. 登录 Docker Hub（需提前在 Secrets 中配置 DOCKER_USERNAME 和 DOCKER_PASSWORD）
      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # 5. 显式拉取基础镜像（带重试），避免构建时拉取超时
      - name: Pull base image with retry
        run: |
          for i in {1..3}; do
            echo "Attempt $i to pull mono:latest..."
            docker pull mono:latest && break || { echo "Pull failed, retry in 10s"; sleep 10; }
          done

      # 6. 构建原始镜像（中间产物，不推送）
      - name: Build original image
        uses: docker/build-push-action@v5
        with:
          context: ./app-source
          file: ./app-source/Dockerfile
          load: true                     # 仅保存到本地，不推送到仓库
          tags: orzg/learnsite-web:build-${{ github.sha }}

      # 7. 安装 Mint (SlimToolkit)
      - name: Install Mint (SlimToolkit)
        run: |
          curl -sL https://raw.githubusercontent.com/mintoolkit/mint/master/scripts/install-mint.sh | sudo -E bash -
          mint --version

      # 8. 使用 Mint 对镜像进行瘦身，生成 dev 标签
      - name: Slim the image with Mint
        run: |
          # 生成瘦身后镜像，直接打上 dev 标签（参数与原 slim 兼容）
          mint build \
            --http-probe=false \
            --tag orzg/learnsite-web:dev \
            orzg/learnsite-web:build-${{ github.sha }}

      # 9. 为了测试，将 dev 镜像临时标记为 latest（测试环境使用）
      - name: Tag dev as latest for testing
        run: docker tag orzg/learnsite-web:dev orzg/learnsite-web:latest

      # 10. 将测试用的 Compose 文件复制到工作目录
      - name: Copy test compose file
        run: cp my-repo/docker-compose.ci.yml .

      # 11. 拉取 MSSQL 镜像（确保存在，通常由 build-mssql-image.yml 推送）
      - name: Pull MSSQL image
        run: docker pull orzg/mssql-learnsite:latest

      # 12. 运行集成测试（依赖 docker-compose.ci.yml）
      - name: Run integration tests
        env:
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}   # 数据库密码，从 Secrets 读取
        run: |
          # 同时设置两个密码变量（值相同）
          MSSQL_SA_PASSWORD="$DB_PASSWORD" \
          DB_PASSWORD="$DB_PASSWORD" \
          docker compose -f docker-compose.ci.yml up -d
          # 等待服务启动
          sleep 15
          # 测试首页
          curl -f http://localhost:8080 || exit 1
          # 可选：添加更多测试，如 /upgrade.aspx
          # 清理测试环境
          docker compose -f docker-compose.ci.yml down

      # 13. 推送 dev 镜像到 Docker Hub（只有测试通过才会推送）
      - name: Push dev image
        run: docker push orzg/learnsite-web:dev

      # 14. 清理中间镜像和临时标签
      - name: Clean up
        if: always()
        run: |
          docker rmi orzg/learnsite-web:build-${{ github.sha }} || true
          docker rmi orzg/learnsite-web:latest || true   # 移除临时 latest 标签
          docker image prune -f